<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>Exhibitor | 訂單列表</title>
    <!-- Fonts & AdminLTE CSS -->
    <link rel="preload" href="/back-end/css/adminlte.css" as="style" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" crossorigin="anonymous" media="print" onload="this.media='all'" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"/>
    <link rel="stylesheet" href="/back-end/css/adminlte.css" />
    <style>
      .chip-group .btn{--bs-btn-padding-y:.25rem;--bs-btn-padding-x:.6rem;--bs-btn-font-size:.85rem}
      .chip-group .btn.active{background:var(--bs-emphasis-color); color:var(--bs-body-bg)}
      .table-orders td .btn{--bs-btn-padding-y:.15rem; --bs-btn-padding-x:.45rem; --bs-btn-font-size:.8rem}
      .search-wrap{display:flex; gap:.5rem; align-items:center}
      .search-wrap .form-control{width:220px}
      .bulkbar{display:none}
      .bulkbar.show{display:flex}
      .pagination .page-link{padding:.25rem .55rem}
    </style>
  </head>
  <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
      <!-- Header（自動注入） -->
    <div data-include="/back-end/header.html"></div>
     

      <!-- Sidebar (使用你提供的) -->
     <aside class="app-sidebar bg-body-secondary" data-bs-theme="dark">
        <div class="sidebar-brand">
          <a href="#" class="brand-link">
            <img src="/back-end/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image opacity-75 shadow" />
            <span class="brand-text fw-light">eventra</span>
          </a>
        </div>
        <div class="sidebar-wrapper">
          <nav class="mt-2">
            <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="navigation" data-accordion="false">
              <li class="nav-item"><a  class="nav-link"><p>展商後台</p></a></li>
              <li class="nav-item menu-open">
                <a href="#" class="nav-link"><i class="nav-icon bi bi-circle-fill"></i><p>展覽管理</p></a>
                <ul class="nav nav-treeview">
                  <li class="nav-item"><a href="/back-end/exhibitor/exhibition_list" class="nav-link"><p>展覽列表</p></a></li>
                
                </ul>
              </li>
              <li class="nav-item menu-open">
                <a href="#" class="nav-link"><i class="nav-icon bi bi-circle-fill"></i><p>銷售管理</p></a>
                <ul class="nav nav-treeview">
                  <li class="nav-item"><a href="/back-end/exhibitor/order_list" class="nav-link"><p>訂單列表</p></a></li>
                  <li class="nav-item"><a href="#" class="nav-link"><p>銷售列表</p></a></li>
                
                </ul>
              </li>
               <li class="nav-item menu-open">
                <a href="#" class="nav-link"><i class="nav-icon bi bi-circle-fill"></i><p>會員中心</p></a>
                <ul class="nav nav-treeview">
                  <li class="nav-item"><a href="/back-end/exhibitor/exhibitor_info" class="nav-link"><p>展商資訊</p></a></li>
                  <li class="nav-item"><a href="/back-end/exhibitor/exhibitor_account_data" class="nav-link"><p>帳戶資料</p></a></li>
                
                </ul>
              </li>
            </ul>
          </nav>
         <!-- 底部：登出連結 -->
          <div class="p-3 border-top">
            <a href="/back-end/exhibitor/exhibitor_login" id="logoutLink" class="nav-link text-danger">
              <i class="bi bi-box-arrow-right me-1"></i> 登出
            </a>
          </div>
        </div>
      </aside>

      <!-- Main -->
      <main class="app-main">
        <!-- Page header -->
        <div class="app-content-header">
          <div class="container-fluid">
            <div class="row align-items-center g-2">
              <div class="col-md-6"><h3 class="mb-0">訂單列表</h3></div>
              <div class="col-md-6 text-md-end">
                <div class="chip-group btn-group" role="group" aria-label="filter">
                  <button class="btn btn-outline-secondary active" data-status="all">全部</button>
                  <button class="btn btn-outline-secondary" data-status="unpaid">未付款</button>
                  <button class="btn btn-outline-secondary" data-status="paid">已付款</button>
                  <button class="btn btn-outline-secondary" data-status="failed">未成立</button>
                  <button class="btn btn-outline-secondary" data-status="cancelled">已取消</button>
                </div>
                <div class="search-wrap d-inline-flex ms-2 align-middle">
                  <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input class="form-control" id="q" placeholder="搜尋 訂單/活動/訂購人" />
                    <button class="btn btn-outline-secondary" id="btnSearch">搜尋</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Content -->
        <div class="app-content">
          <div class="container-fluid">

            <!-- Bulk action bar -->
            <div id="bulkbar" class="bulkbar alert alert-secondary d-flex align-items-center justify-content-between">
              <div><span id="selCount">0</span> 筆已選取</div>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="btnExport"><i class="bi bi-download me-1"></i>匯出CSV</button>
                <button class="btn btn-outline-secondary btn-sm" id="btnClearSel">清除選取</button>
              </div>
            </div>

            <div class="card">
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table m-0 table-hover table-orders">
                    <thead class="table-light align-middle">
                      <tr>
                        <th style="width:40px;"><input class="form-check-input" type="checkbox" id="checkAll"></th>
                        <th>訂單編號</th>
                        <th>活動名稱</th>
                        <th>訂購人</th>
                        <th>票種</th>
                        <th class="text-end" style="width:90px;">數量</th>
                        <th class="text-end" style="width:120px;">金額</th>
                        <th style="width:120px;">付款狀態</th>
                        <th style="width:150px;">訂單時間</th>
                        <!-- <th style="width:140px;" class="text-end">操作</th> -->
                      </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                  </table>
                </div>
              </div>
              <div class="card-footer d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="text-secondary small">共 <span id="totalCount">0</span> 筆</div>
                <nav>
                  <ul class="pagination pagination-sm mb-0" id="pager"></ul>
                </nav>
              </div>
            </div>

          </div>
        </div>
      </main>

     <footer class="app-footer">
        <!-- <div class="float-end d-none d-sm-inline">Anything you want</div>
        <strong>Copyright &copy; 2014-2025 <a href="https://adminlte.io">AdminLTE.io</a>.</strong> All rights reserved. -->
      </footer>
    </div>

    <!-- Scripts -->
    
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/browser/overlayscrollbars.browser.es6.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js"></script>
    <script src="/back-end/js/adminlte.min.js"></script>
    <script src="/front-end/js/g1_10_custom_common_csrf.js"></script>
    <script>
      // ---- Mock data ----
      const ORDERS = [
        {id:'12345', event:'xxx', buyer:'ooo', ticket:'全票', qty:1, amount:1000, status:'paid',  time:'2025/07/18'},
        {id:'13254', event:'aaa', buyer:'oxo', ticket:'全票', qty:2, amount:3000, status:'unpaid',time:'2025/07/11'},
        {id:'88881', event:'未來展', buyer:'王小明', ticket:'學生票', qty:3, amount:1500, status:'cancelled', time:'2025/06/30'},
        {id:'88882', event:'攝影展', buyer:'陳小美', ticket:'全票', qty:1, amount:500, status:'failed', time:'2025/06/22'}
      ];

      // ---- State ----
      let state = { q:'', status:'all', page:1, size:10, selected:new Set() };

      const tbody = document.getElementById('tbody');
      const pager = document.getElementById('pager');
      const totalCountEl = document.getElementById('totalCount');
      const bulkbar = document.getElementById('bulkbar');
      const selCount = document.getElementById('selCount');

      // ---- Render ----
      function render(){
        // filter
        let rows = ORDERS.filter(o=>{
          const matchStatus = state.status==='all' || o.status===state.status;
          const q = state.q.trim().toLowerCase();
          const matchQ = !q || (o.id+o.event+o.buyer+o.ticket).toLowerCase().includes(q);
          return matchStatus && matchQ;
        });
        totalCountEl.textContent = rows.length;

        // pagination
        const totalPages = Math.max(1, Math.ceil(rows.length / state.size));
        if(state.page>totalPages) state.page = totalPages;
        const start = (state.page-1)*state.size;
        const pageRows = rows.slice(start, start+state.size);

        // tbody
        tbody.innerHTML = pageRows.map(o=>{
          const checked = state.selected.has(o.id) ? 'checked' : '';
          const badge = o.status==='paid'?'success': o.status==='unpaid'?'secondary': o.status==='cancelled'?'danger':'warning';
          const label = o.status==='paid'?'已付款': o.status==='unpaid'?'未付款': o.status==='cancelled'?'已取消':'未成立';
          return `<tr>
            <td><input class="form-check-input row-check" type="checkbox" data-id="${o.id}" ${checked}></td>
            <td>${o.id}</td>
            <td>${o.event}</td>
            <td>${o.buyer}</td>
            <td>${o.ticket}</td>
            <td class="text-end">${o.qty}</td>
            <td class="text-end">${o.amount.toLocaleString()}</td>
            <td><span class="badge text-bg-${badge}">${label}</span></td>
            <td>${o.time}</td>
          </tr>`;
        }).join('');

        // pager
        pager.innerHTML = '';
        const createItem = (txt, page, disabled=false, active=false)=>{
          const li = document.createElement('li'); li.className = `page-item ${disabled?'disabled':''} ${active?'active':''}`;
          li.innerHTML = `<a class="page-link" href="#">${txt}</a>`;
          li.addEventListener('click', (e)=>{e.preventDefault(); if(disabled) return; state.page=page; render();});
          return li;
        };
        pager.appendChild(createItem('«', Math.max(1,state.page-1), state.page===1));
        for(let i=1;i<=totalPages;i++) pager.appendChild(createItem(i, i, false, i===state.page));
        pager.appendChild(createItem('»', Math.min(totalPages,state.page+1), state.page===totalPages));

        // header checkbox state
        const checkAll = document.getElementById('checkAll');
        const visibleIds = new Set(pageRows.map(o=>o.id));
        const selectedOnPage = [...state.selected].filter(id=>visibleIds.has(id));
        checkAll.checked = selectedOnPage.length && selectedOnPage.length===pageRows.length;
        checkAll.indeterminate = selectedOnPage.length>0 && selectedOnPage.length<pageRows.length;

        // bulkbar
        selCount.textContent = state.selected.size;
        bulkbar.classList.toggle('show', state.selected.size>0);
      }

      // ---- Events ----
      document.querySelectorAll('.chip-group .btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('.chip-group .btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          state.status = btn.dataset.status; state.page=1; render();
        });
      });

      document.getElementById('btnSearch').addEventListener('click', ()=>{
        state.q = document.getElementById('q').value; state.page=1; render();
      });
      document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('btnSearch').click(); }});

      document.getElementById('checkAll').addEventListener('change', (e)=>{
        const checked = e.target.checked;
        const idsOnPage = [...tbody.querySelectorAll('.row-check')].map(i=>i.dataset.id);
        idsOnPage.forEach(id=>{ if(checked) state.selected.add(id); else state.selected.delete(id); });
        render();
      });

      tbody.addEventListener('change', (e)=>{
        const box = e.target.closest('.row-check'); if(!box) return;
        const id = box.dataset.id; if(box.checked) state.selected.add(id); else state.selected.delete(id);
        render();
      });

      document.getElementById('btnClearSel').addEventListener('click', ()=>{ state.selected.clear(); render(); });
      document.getElementById('btnExport').addEventListener('click', ()=>{
        const header = ['訂單編號','活動名稱','訂購人','票種','數量','金額','付款狀態','訂單時間'];
        const rows = ORDERS.filter(o=>state.selected.has(o.id)).map(o=>[
          o.id,o.event,o.buyer,o.ticket,o.qty,o.amount,
          o.status==='paid'?'已付款':o.status==='unpaid'?'未付款':o.status==='cancelled'?'已取消':'未成立',
          o.time
        ]);
        if(!rows.length){ alert('請先選取要匯出的訂單'); return; }
        const csv = [header.join(','), ...rows.map(r=>r.join(','))].join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'orders.csv'; a.click();
      });

      tbody.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-act]'); if(!btn) return;
        const id = btn.dataset.id;
        if(btn.dataset.act==='view'){
          alert('檢視訂單 '+id+'（示意）');
        }else if(btn.dataset.act==='manage'){
          alert('管理訂單 '+id+'（示意）');
        }
      });

      // init
      render();
    </script>
          <script>
        document.getElementById('logoutLink')?.addEventListener('click', (e) => {
          e.preventDefault();
          // 清除登入紀錄
          sessionStorage.removeItem('exhibitorSession');
          // 導回登入頁
          window.location.href = '/back-end/exhibitor/exhibitor_login';
        });
      </script>

      <script>
    (async () => {
      // 讓放了 data-include 的容器先隱藏，避免 FOUC
      document.querySelectorAll('[data-include]').forEach(el => el.style.visibility = 'hidden');

      // 載入所有 partial
      const tasks = [...document.querySelectorAll('[data-include]')].map(async (el) => {
        const url = el.getAttribute('data-include');
        const bust = `v=${encodeURIComponent((window.__PARTIALS_VERSION__) || '1')}`; // 可手動改版本清快取
        const src = url.includes('?') ? `${url}&${bust}` : `${url}?${bust}`;
        try {
          const res = await csrfFetchToRedirect(src, { cache: 'no-store' });
          if (!res.ok) throw new Error(res.statusText);
          el.innerHTML = await res.text();
          el.style.visibility = 'visible';
          el.dispatchEvent(new CustomEvent('partial:loaded', { bubbles: true }));
        } catch (err) {
          el.innerHTML = `<!-- include failed: ${url} -->`;
          el.style.visibility = 'visible';
          console.warn('Include failed:', url, err);
        }
      });

      await Promise.all(tasks);

      // 1) 根據目前 URL 自動加上 active（如果 sidebar 裡的 a[href] 剛好指到當前頁）
      const here = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('aside a.nav-link, aside .nav-treeview a.nav-link').forEach(a => {
        const href = (a.getAttribute('href') || '').split('/').pop();
        if (href && href === here) a.classList.add('active');
      });

      // 2) AdminLTE 如果要初始化（依你專案需要）
      // window.AdminLTE && window.AdminLTE.autoInit?.();

      // 3) 登出（若要清 sessionStorage / localStorage）
      const logout = document.getElementById('logoutLink');
      if (logout) {
        logout.addEventListener('click', (e) => {
          // e.preventDefault(); // 若要攔截導頁再手動跳轉，取消註解
          sessionStorage.removeItem('auth');       // 依專案實際使用的 key
          sessionStorage.removeItem('editingEvent');
          // location.href = logout.getAttribute('href'); // 若攔截，最後導回登入頁
        });
      }
    })();
    </script>
  </body>
</html>

<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>Exhibitor | 訂單列表</title>
    <!-- Fonts & AdminLTE CSS -->
    <link rel="preload" href="/back-end/css/adminlte.css" as="style" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" crossorigin="anonymous" media="print" onload="this.media='all'" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"/>
    <link rel="stylesheet" href="/back-end/css/adminlte.css" />
    <style>
      .chip-group .btn{--bs-btn-padding-y:.25rem;--bs-btn-padding-x:.6rem;--bs-btn-font-size:.85rem}
      .chip-group .btn.active{background:var(--bs-emphasis-color); color:var(--bs-body-bg)}
      .table-orders td .btn{--bs-btn-padding-y:.15rem; --bs-btn-padding-x:.45rem; --bs-btn-font-size:.8rem}
      .search-wrap{display:flex; gap:.5rem; align-items:center}
      .search-wrap .form-control{width:220px}
      .bulkbar{display:none}
      .bulkbar.show{display:flex}
      .pagination .page-link{padding:.25rem .55rem}
    </style>
  </head>
  <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
      <!-- Header（自動注入） -->
    <div data-include="/back-end/header.html"></div>
     

      <!-- Sidebar (使用你提供的) -->
     <aside class="app-sidebar bg-body-secondary" data-bs-theme="dark">
        <div class="sidebar-brand">
          <a href="/back-end/exhibitor/back_end_homepage" class="brand-link">
            <img src="/back-end/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image opacity-75 shadow" />
            <span class="brand-text fw-light">eventra</span>
          </a>
        </div>
        <div class="sidebar-wrapper">
          <nav class="mt-2">
            <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="navigation" data-accordion="true">
              <li class="nav-item">
                <a href="#" class="nav-link"><i class="nav-icon bi bi-circle-fill"></i><p>展覽管理</p></a>
                <ul class="nav nav-treeview">
                  <li class="nav-item"><a href="/back-end/exhibitor/exhibition_list" class="nav-link"><p>展覽列表</p></a></li>
                
                </ul>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link"><i class="nav-icon bi bi-circle-fill"></i><p>銷售管理</p></a>
                <ul class="nav nav-treeview">
                  <li class="nav-item"><a href="/back-end/exhibitor/order_list" class="nav-link"><p>訂單列表</p></a></li>
                  <!-- <li class="nav-item"><a href="#" class="nav-link"><p>銷售列表</p></a></li> -->
                
                </ul>
              </li>
               <li class="nav-item">
                <a href="#" class="nav-link"><i class="nav-icon bi bi-circle-fill"></i><p>會員中心</p></a>
                <ul class="nav nav-treeview">
                  <li class="nav-item"><a href="/back-end/exhibitor/exhibitor_info" class="nav-link"><p>展商資訊</p></a></li>
                  <li class="nav-item"><a href="/back-end/exhibitor/exhibitor_account_data" class="nav-link"><p>帳戶資料</p></a></li>
                
                </ul>
              </li>
            </ul>
          </nav>
         <!-- 底部：登出連結 -->
          <div class="p-3 border-top">
            <a href="/back-end/exhibitor/exhibitor_login" id="mylogout" class="nav-link text-danger">
              <i class="bi bi-box-arrow-right me-1"></i> 登出
            </a>
          </div>
        </div>
      </aside>

      <!-- Main -->
      <main class="app-main">
        <!-- Page header -->
        <div class="app-content-header">
          <div class="container-fluid">
            <div class="row align-items-center g-2">
              <div class="col-md-6"><h3 class="mb-0">訂單列表</h3></div>
              <div class="col-md-6 text-md-end">
                <div class="chip-group btn-group" role="group" aria-label="filter">
				  <!-- 全部 -->
					<a class="btn btn-outline-secondary"
					   th:classappend="${status} == '' ? ' active'"
					   th:href="@{/back-end/exhibitor/order_list(page=0, size=${size}, q=${q})}">全部</a>
					
					<!-- 未付款 -->
					<a class="btn btn-outline-secondary"
					   th:classappend="${status} == '付款中' ? ' active'"
					   th:href="@{/back-end/exhibitor/order_list(status='付款中', page=0, size=${size}, q=${q})}">付款中</a>
					
					<!-- 已付款 -->
					<a class="btn btn-outline-secondary"
					   th:classappend="${status} == '已付款' ? ' active'"
					   th:href="@{/back-end/exhibitor/order_list(status='已付款', page=0, size=${size}, q=${q})}">已付款</a>
					
					<!-- 未成立 -->
					<a class="btn btn-outline-secondary"
					   th:classappend="${status} == '付款失敗' ? ' active'"
					   th:href="@{/back-end/exhibitor/order_list(status='付款失敗', page=0, size=${size}, q=${q})}">付款失敗</a>
					
					<!-- 逾時 -->
					<a class="btn btn-outline-secondary"
					   th:classappend="${status} == '付款逾時' ? ' active'"
					   th:href="@{/back-end/exhibitor/order_list(status='付款逾時', page=0, size=${size}, q=${q})}">付款逾時</a>
					
					<!-- 已退款 -->
					<a class="btn btn-outline-secondary"
					   th:classappend="${status} == '已退款' ? ' active'"
					   th:href="@{/back-end/exhibitor/order_list(status='已退款', page=0, size=${size}, q=${q})}">已退款</a>

				</div>

                <form th:action="@{/back-end/exhibitor/order_list}" method="get" class="search-wrap d-inline-flex ms-2 align-middle">
				  <input type="hidden" name="status" th:value="${param.status}">
				  <input type="hidden" name="size"   th:value="${param.size}?:10">
				  <input type="hidden" name="page"   value="0"><!-- 搜尋時回到第一頁 -->
				  <div class="input-group input-group-sm">
				    <span class="input-group-text"><i class="bi bi-search"></i></span>
				    <input class="form-control" id="q" name="q" placeholder="搜尋 訂單/活動/訂購人" th:value="${param.q}">
				    <button class="btn btn-outline-secondary" type="submit">搜尋</button>
				  </div>
				</form>

              </div>
            </div>
          </div>
        </div>

        <!-- Content -->
        <div class="app-content">
          <div class="container-fluid">

            <!-- Bulk action bar -->
            <div id="bulkbar" class="bulkbar alert alert-secondary d-flex align-items-center justify-content-between">
              <div><span id="selCount">0</span> 筆已選取</div>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="btnExport"><i class="bi bi-download me-1"></i>匯出CSV</button>
                <button class="btn btn-outline-secondary btn-sm" id="btnClearSel">清除選取</button>
              </div>
            </div>

            <div class="card">
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table m-0 table-hover table-orders">
                    <thead class="table-light align-middle">
                      <tr>
                        <th style="width:40px;"><input class="form-check-input" type="checkbox" id="checkAll"></th>
                        <th>訂單編號</th>
                        <th>展覽名稱</th>
                        <th>訂購人</th>
                        <th>票種</th>
                        <th class="text-end" style="width:90px;">數量</th>
                        <th class="text-end" style="width:120px;">金額</th>
                        <th style="width:120px;">付款狀態</th>
                        <th style="width:150px;">訂單時間</th>
                        <!-- <th style="width:140px;" class="text-end">操作</th> -->
                      </tr>
                    </thead>
                    <tbody>
					  <tr th:each="o : ${orders}">
					    <td>
					      <input class="form-check-input row-check" type="checkbox"
					             th:attr="data-id=${o.orderUlid}">
					    </td>
					
					    <td th:text="${o.orderUlid}">ULID</td>
					
					    <!-- 若要顯示活動名稱，DTO 要多帶；先留空或用 '-' -->
					    <td th:text="${o.exhibitionName} ?: '-'">-</td>
					
					    <td th:text="${o.fullName}">訂購人</td>
					
					    <!-- 票種/數量（DTO 目前只有 itemCount，票種名稱若要顯示需擴充 DTO） -->
					    <td th:text="${o.ticketTypeName} ?: '-'">-</td>
					
					    <td class="text-end" th:text="${o.itemCount}">0</td>
					
					    <td class="text-end" th:text="${#numbers.formatInteger(o.totalAmount, 0)}">0</td>
					
					    <td>
						  <th:block th:switch="${o.orderStatus.name()}">
						    <span th:case="'已付款'"   class="badge text-bg-success">已付款</span>
						    <span th:case="'付款中'"   class="badge text-bg-secondary">未付款</span>
						    <span th:case="'付款失敗'" class="badge text-bg-warning">未成立</span>
						    <span th:case="'付款逾時'" class="badge text-bg-dark">逾時</span>
						    <span th:case="'已退款'"   class="badge text-bg-info">已退款</span>
						    <span th:case="*" class="badge text-bg-secondary" th:text="${o.orderStatus}">狀態</span>
						  </th:block>
						</td>

					    <td th:text="${#dates.format(o.createdAt, 'yyyy/MM/dd HH:mm')}">2025/07/18 12:00</td>
					  </tr>
					
					  <!-- 空狀態 -->
					  <tr th:if="${#lists.isEmpty(orders)}">
					    <td colspan="9" class="text-center text-secondary py-4">目前沒有資料</td>
					  </tr>
					</tbody>

                  </table>
                </div>
              </div>
              <div class="card-footer d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="text-secondary small">共 <span th:text="${totalElements}">0</span> 筆</div>
                <nav th:if="${totalElements > 0}">
                  <ul class="pagination pagination-sm mb-0">
					<!-- 上一頁 -->
					<li class="page-item" th:classappend="${currentPage == 0} ? ' disabled'">
					  <a class="page-link"
					     th:href="@{/back-end/exhibitor/order_list(page=${currentPage-1}, size=${size}, status=${status}, q=${q})}">«</a>
					</li>
					
					<!-- 頁碼 -->
					<li class="page-item"
					    th:each="i : ${#numbers.sequence(0, totalPage-1)}"
					    th:classappend="${i == currentPage} ? ' active'">
					  <a class="page-link"
					     th:text="${i+1}"
					     th:href="@{/back-end/exhibitor/order_list(page=${i}, size=${size}, status=${status}, q=${q})}">1</a>
					</li>
					
					<!-- 下一頁 -->
					<li class="page-item" th:classappend="${currentPage+1 == totalPage} ? ' disabled'">
					  <a class="page-link"
					     th:href="@{/back-end/exhibitor/order_list(page=${currentPage+1}, size=${size}, status=${status}, q=${q})}">»</a>
					</li>


					</ul>

                </nav>
              </div>
            </div>

          </div>
        </div>
      </main>

     <footer class="app-footer">
        <!-- <div class="float-end d-none d-sm-inline">Anything you want</div>
        <strong>Copyright &copy; 2014-2025 <a href="https://adminlte.io">AdminLTE.io</a>.</strong> All rights reserved. -->
      </footer>
    </div>

    <!-- Scripts -->
    
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/browser/overlayscrollbars.browser.es6.min.js"></script>
    <script src="/back-end/js/adminlte.min.js"></script>
    <script src="/back-end/js/sidebar_toggle.js"></script>
    <script src="/front-end/js/g1_10_custom_common_csrf.js"></script>
    
    <script>
	  // 全選
	  document.getElementById('checkAll')?.addEventListener('change', (e)=>{
	    const checked = e.target.checked;
	    document.querySelectorAll('.row-check').forEach(i=> i.checked = checked);
	    toggleBulkbar();
	  });
	
	  // 單列勾選
	  document.addEventListener('change', (e)=>{
	    if(!e.target.classList.contains('row-check')) return;
	    toggleBulkbar();
	  });
	
	  // 匯出 CSV：把目前表格中「有勾選」的列抓出來
	  document.getElementById('btnExport')?.addEventListener('click', ()=>{
	    const rows = [...document.querySelectorAll('tbody tr')].filter(tr=> tr.querySelector('.row-check')?.checked);
	    if(!rows.length){ alert('請先選取要匯出的訂單'); return; }
	
	    const header = ['訂單編號','活動名稱','訂購人','票種','數量','金額','付款狀態','訂單時間'];
	    const data = rows.map(tr=>{
	      const tds = tr.querySelectorAll('td');
	      return [
	        tds[1]?.innerText.trim(), // 訂單編號
	        tds[2]?.innerText.trim(), // 活動名稱（目前是 '-'）
	        tds[3]?.innerText.trim(), // 訂購人
	        tds[4]?.innerText.trim(), // 票種（目前是 '-'）
	        tds[5]?.innerText.trim(), // 數量
	        tds[6]?.innerText.trim(), // 金額
	        tds[7]?.innerText.trim(), // 付款狀態
	        tds[8]?.innerText.trim(), // 訂單時間
	      ];
	    });
	
	    const csv = [header, ...data]
	      .map(r=> r.map(v => /[",\n]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v).join(','))
	      .join('\n');
	
	    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
	    const a = document.createElement('a');
	    a.href = URL.createObjectURL(blob);
	    a.download = 'orders.csv';
	    a.click();
	  });
	
	  // 清除選取
	  document.getElementById('btnClearSel')?.addEventListener('click', ()=>{
	    document.querySelectorAll('.row-check').forEach(i=> i.checked = false);
	    const checkAll = document.getElementById('checkAll'); if (checkAll) checkAll.checked = false;
	    toggleBulkbar();
	  });
	
	  function toggleBulkbar(){
	    const count = document.querySelectorAll('.row-check:checked').length;
	    document.getElementById('selCount').textContent = count;
	    document.getElementById('bulkbar')?.classList.toggle('show', count>0);
	  }
	</script>
    
    <script>
    (function setupSidebarActive(){
    	  const menu = document.querySelector('.sidebar-menu');
    	  if (!menu) return;

    	  // 清掉舊狀態
    	  menu.querySelectorAll('a.nav-link.active').forEach(a => a.classList.remove('active'));
    	  menu.querySelectorAll('li.nav-item.menu-open').forEach(li => li.classList.remove('menu-open'));

    	  // 找目前頁
    	  const here = new URL(location.href).pathname;
    	  const links = [...menu.querySelectorAll('a.nav-link[href]:not([href="#"])')];

    	  let activeLink = links.find(a => {
    	    try { return new URL(a.getAttribute('href'), location.origin).pathname === here; }
    	    catch { return false; }
    	  });
    	  if (!activeLink) {
    	    const hereName = here.split('/').pop();
    	    activeLink = links.find(a => (a.getAttribute('href')||'').split('/').pop() === hereName);
    	  }
    	  if (!activeLink) return;

    	  // 高亮 + 展開父群組（交給 AdminLTE 處理動畫與互斥）
    	  activeLink.classList.add('active');
    	  activeLink.closest('.nav-treeview')?.closest('.nav-item')?.classList.add('menu-open');
    	})();

    </script>
    <script>
     (async () => {
      // 讓放了 data-include 的容器先隱藏，避免 FOUC
      document.querySelectorAll('[data-include]').forEach(el => el.style.visibility = 'hidden');

      // 載入所有 partial
      const tasks = [...document.querySelectorAll('[data-include]')].map(async (el) => {
        const url = el.getAttribute('data-include');
        const bust = `v=${encodeURIComponent((window.__PARTIALS_VERSION__) || '1')}`; // 可手動改版本清快取
        const src = url.includes('?') ? `${url}&${bust}` : `${url}?${bust}`;
        try {
          const res = await csrfFetchToRedirect(src, { cache: 'no-store' });
          if (!res.ok) throw new Error(res.statusText);
          el.innerHTML = await res.text();
          el.style.visibility = 'visible';
          el.dispatchEvent(new CustomEvent('partial:loaded', { bubbles: true }));
        } catch (err) {
          el.innerHTML = `<!-- include failed: ${url} -->`;
          el.style.visibility = 'visible';
          console.warn('Include failed:', url, err);
        }
      });

      await Promise.all(tasks);

      // 1) 根據目前 URL 自動加上 active（如果 sidebar 裡的 a[href] 剛好指到當前頁）
  	// 呼叫時機：partials 載入完 & DOM 準備好
    /*   document.addEventListener('partial:loaded', setupSidebar);
      document.addEventListener('DOMContentLoaded', setupSidebar);

      function setupSidebar(){
        const herePath = new URL(location.href).pathname; // 例如 /back-end/exhibitor/exhibitor_info
        const aside = document.querySelector('aside');
        if(!aside) return;

        // 1-1) 清理舊狀態
        aside.querySelectorAll('a.nav-link.active').forEach(a=>a.classList.remove('active'));
        aside.querySelectorAll('.nav-item.menu-open').forEach(li=>li.classList.remove('menu-open'));

        // 1-2) 找出與目前路徑完全相同的連結
        const links = [...aside.querySelectorAll('a.nav-link[href]')];
        const activeLink =
          links.find(a => {
            try {
              return new URL(a.getAttribute('href'), location.origin).pathname === herePath;
            } catch { return false; }
          }) ||
          // 退一步：以檔名比對
          links.find(a => (a.getAttribute('href')||'').split('/').pop() === herePath.split('/').pop());

        if(!activeLink) return;

        // 1-3) 標記 active 並僅打開該群組
        activeLink.classList.add('active');
        const group = activeLink.closest('.nav-item'); // 上層群組 li
        if(group){
          group.classList.add('menu-open'); // AdminLTE 會顯示這組的 .nav-treeview
        }

        // 1-4) 其餘群組保持關閉（無 menu-open 就是關閉）
        aside.querySelectorAll('.nav.nav-treeview').forEach(ul => {
          const parent = ul.closest('.nav-item');
          ul.style.display = parent?.classList.contains('menu-open') ? '' : 'none';
        });
      } */
 
      // 2) AdminLTE 如果要初始化（依你專案需要）
      // window.AdminLTE && window.AdminLTE.autoInit?.();

      // 3) 登出（若要清 sessionStorage / localStorage）
      const logout = document.getElementById('mylogout');
      if (logout) {
        logout.addEventListener('click', (e) => {
          e.preventDefault(); // 若要攔截導頁再手動跳轉，取消註解
//           sessionStorage.removeItem('auth');       // 依專案實際使用的 key
//           sessionStorage.removeItem('editingEvent');
          // location.href = logout.getAttribute('href'); // 若攔截，最後導回登入頁
          
          // 可以不用 csrfFetch (有另外放權限)
          fetch("/api/auth/logout/exhibitor", { 
        	method: "POST",
          })
          .then((res) => {
        	  if(res.status === 204)
        		  location.href = "/back-end/exhibitor/exhibitor_login";
        	  if(!res.ok) throw new Error("Not 2XX");
          })
          .catch(error => console.log(error))
          
        });
      }
     })(); 
    </script>
  </body>
</html>

<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>Exhibitor | 會員中心－展商資訊</title>
    <!-- Fonts & AdminLTE CSS -->
    <link rel="preload" href="/back-end/css/adminlte.css" as="style" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" crossorigin="anonymous" media="print" onload="this.media='all'" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"/>
    <link rel="stylesheet" href="/back-end/css/adminlte.css" />
    <style>
      .section-title{font-weight:700}
      .kv{display:flex; gap:1rem; padding:.75rem 1rem; background:var(--bs-tertiary-bg); border-radius:.5rem; align-items:center}
      .kv .k{width:72px; color:var(--bs-secondary-color)}
      .intro-box{min-height:240px; border:1px dashed var(--bs-border-color); border-radius:.5rem; padding:1rem; background:var(--bs-body-bg)}
      .btn-icon-sm{--bs-btn-padding-y:.25rem; --bs-btn-padding-x:.5rem}
      .kv .k{
		  /* 原本 width:72px 會造成換行 */
		  flex: 0 0 120px;      /* 或 110~140px，給得比文字長一點 */
		  white-space: nowrap;  /* 不允許換行 */
		  word-break: keep-all; /* 中文盡量不斷詞 */
		}
    </style>
  </head>
  <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
      <!-- Header（自動注入） -->
    <div data-include="/back-end/header.html"></div>
     

      <!-- Sidebar (使用你提供的) -->
     <aside class="app-sidebar bg-body-secondary" data-bs-theme="dark">
        <div class="sidebar-brand">
          <a href="/back-end/exhibitor/back_end_homepage" class="brand-link">
            <img src="/back-end/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image opacity-75 shadow" />
            <span class="brand-text fw-light">eventra</span>
          </a>
        </div>
        <div class="sidebar-wrapper">
          <nav class="mt-2">
            <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="navigation" data-accordion="true">
              <li class="nav-item">
                <a href="#" class="nav-link"><i class="nav-icon bi bi-circle-fill"></i><p>展覽管理</p></a>
                <ul class="nav nav-treeview">
                  <li class="nav-item"><a href="/back-end/exhibitor/exhibition_list" class="nav-link"><p>展覽列表</p></a></li>
                
                </ul>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link"><i class="nav-icon bi bi-circle-fill"></i><p>銷售管理</p></a>
                <ul class="nav nav-treeview">
                  <li class="nav-item"><a href="/back-end/exhibitor/order_list" class="nav-link"><p>訂單列表</p></a></li>
                  <!-- <li class="nav-item"><a href="#" class="nav-link"><p>銷售列表</p></a></li>
                 -->
                </ul>
              </li>
               <li class="nav-item">
                <a href="#" class="nav-link"><i class="nav-icon bi bi-circle-fill"></i><p>會員中心</p></a>
                <ul class="nav nav-treeview">
                  <li class="nav-item"><a href="/back-end/exhibitor/exhibitor_info" class="nav-link"><p>展商資訊</p></a></li>
                  <li class="nav-item"><a href="/back-end/exhibitor/exhibitor_account_data" class="nav-link"><p>帳戶資料</p></a></li>
                
                </ul>
              </li>
            </ul>
          </nav>
         <!-- 底部：登出連結 -->
          <div class="p-3 border-top">
            <a href="/back-end/exhibitor/exhibitor_login" id="mylogout" class="nav-link text-danger">
              <i class="bi bi-box-arrow-right me-1"></i> 登出
            </a>
          </div>
        </div>
      </aside>

      <!-- Main -->
      <main class="app-main">
      <!-- 成功訊息 -->
		<div class="container-fluid" th:if="${msg}">
		  <div class="alert alert-success alert-dismissible fade show" role="alert">
		    <span th:text="${msg}">更新成功！</span>
		    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		  </div>
		</div>
        <div class="app-content-header">
          <div class="container-fluid">
            <div class="row align-items-center">
              <div class="col-sm-8"><h3 class="mb-0">會員中心－展商資訊</h3></div>
              <div class="col-sm-4 text-sm-end mt-2 mt-sm-0">
                <button type="button"
				        class="btn btn-outline-secondary btn-sm"
				        id="btnEdit"
				        th:attr="data-company-name=${exhibitor?.companyName},
				                 data-reg-name=${exhibitor?.exhibitorRegistrationName},
				                 data-phone=${exhibitor?.contactPhone},
				                 data-email=${exhibitor?.email},
				                 data-about=${exhibitor?.about}">
				  <i class="bi bi-pencil me-1"></i>編輯
				</button>

              </div>
            </div>
          </div>
        </div>

        <div class="app-content">
          <div class="container-fluid">
            <div class="card mb-4">
              <div class="card-header"><span class="section-title">展商資訊</span></div>
              <div class="card-body">
              <div class="kv mb-2"><div class="k">公司/單位名稱</div><div id="vCompanyName"
				     th:text="${exhibitor != null 
				                 ? (!#strings.isEmpty(exhibitor.companyName) 
				                      ? exhibitor.companyName 
				                      : (!#strings.isEmpty(exhibitor.companyName) 
				                           ? exhibitor.companyName 
				                           : '-'))
				                 : '-'}">-</div>
				 </div>
                <div class="kv mb-2"><div class="k">名稱</div><div id="vName"
				     th:text="${exhibitor != null 
				                 ? (!#strings.isEmpty(exhibitor.exhibitorRegistrationName) 
				                      ? exhibitor.exhibitorRegistrationName 
				                      : (!#strings.isEmpty(exhibitor.companyName) 
				                           ? exhibitor.companyName 
				                           : '-'))
				                 : '-'}">-</div>
				</div>
                <!-- <div class="kv mb-2"><div class="k">聯絡資訊</div><div></div></div> -->
                <div class="kv mb-2"><div class="k">電話</div><div id="vPhone" th:text="${exhibitor != null && exhibitor.contactPhone != null ? exhibitor.contactPhone : '-'}">-</div></div>
                <div class="kv mb-2"><div class="k">信箱</div><div id="vEmail" th:text="${exhibitor != null && exhibitor.email != null ? exhibitor.email : '-'}">-</div></div>
              </div>
            </div>

            <div class="card">
              <div class="card-header"><span class="section-title">介紹</span></div>
              <div class="card-body">
                <div class="intro-box" id="vIntro" th:text="${exhibitor != null && exhibitor.about != null && !#strings.isEmpty(exhibitor.about) ? exhibitor.about : '(尚未填寫介紹)'}">（尚未填寫介紹）</div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer class="app-footer">
        <!-- <div class="float-end d-none d-sm-inline">Anything you want</div>
        <strong>Copyright &copy; 2014-2025 <a href="https://adminlte.io">AdminLTE.io</a>.</strong> All rights reserved. -->
      </footer>
    </div>

    <!-- 編輯 Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">編輯展商資訊</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <form id="vendorForm"
				      th:action="@{/back-end/exhibitor/exhibitor_info/update}"
				      th:object="${infoForm}"
				      method="post" class="row g-3 needs-validation" novalidate>
				  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
				
				  <div class="modal-body">
				    <div class="row g-3">
				    <div class="col-md-6">
				        <label class="form-label">公司/單位名稱</label>
				        <input type="text" class="form-control"
				               th:field="*{companyName}" maxlength="255" 
				               th:errorclass="is-invalid"
				               required 
				               />
				        <div class="invalid-feedback" th:if="${#fields.hasErrors('companyName')}"
				             th:errors="*{companyName}"></div>
				      </div>
				      <div class="col-md-6">
				        <label class="form-label">名稱</label>
				        <input type="text" class="form-control"
				               th:classappend="${#fields.hasErrors('exhibitorRegistrationName')}? ' is-invalid' : ''"
				               th:field="*{exhibitorRegistrationName}" maxlength="100" />
				      </div>
				
				      <div class="col-md-6">
				        <label class="form-label">聯絡電話</label>
				        <input type="text" class="form-control"
				               th:field="*{contactPhone}" maxlength="10" pattern="^09\d{8}$" 
				               th:errorclass="is-invalid"
				               required 
				               />
				        <div class="invalid-feedback" th:if="${#fields.hasErrors('contactPhone')}"
				             th:errors="*{contactPhone}">123</div>
				      </div>
				
				      <div class="col-md-12">
				        <label class="form-label">信箱</label>
				        <input type="email" class="form-control"
				               th:field="*{email}" maxlength="100" 
				               th:errorclass="is-invalid"
				               required 
				               />
				        <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}"
				             th:errors="*{email}"></div>
				      </div>
				
				      <div class="col-12">
				        <label class="form-label">介紹</label>
				        <textarea class="form-control"
				                  th:classappend="${#fields.hasErrors('about')}? ' is-invalid' : ''"
				                  th:field="*{about}" rows="6" maxlength="255"></textarea>
				        <div class="invalid-feedback" th:if="${#fields.hasErrors('about')}"
				             th:errors="*{about}"></div>
				      </div>
				    </div>
				  </div>
				
				  <div class="modal-footer">
				    <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">取消</button>
				    <button class="btn btn-primary" type="submit">儲存</button>
				  </div>
				</form>
		    </div>
		  </div>
		</div>
    

    <!-- Scripts -->
    
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/browser/overlayscrollbars.browser.es6.min.js"></script>
    <script src="/back-end/js/adminlte.min.js"></script>
    <script src="/back-end/js/sidebar_toggle.js"></script>
    <script src="/front-end/js/g1_10_custom_common_csrf.js"></script>

   
	  

	<script>
	(function () {
	  const modalNode = document.getElementById('editModal');
	  const formNode  = document.getElementById('vendorForm');
	  const editBtn   = document.getElementById('btnEdit');
	  if (!modalNode || !formNode || !editBtn) return;
	
	  const modal = bootstrap.Modal.getOrCreateInstance(modalNode);
	
	  // 以資料庫原值回填
	  function fillWithDbDefaults() {
	    formNode.querySelector('[name="companyName"]').value               = editBtn.dataset.companyName || '';
	    formNode.querySelector('[name="exhibitorRegistrationName"]').value = editBtn.dataset.regName || '';
	    formNode.querySelector('[name="contactPhone"]').value              = editBtn.dataset.phone || '';
	    formNode.querySelector('[name="email"]').value                     = editBtn.dataset.email || '';
	    formNode.querySelector('[name="about"]').value                     = editBtn.dataset.about || '';
	  }
	
	  // 清掉前端驗證樣式（避免綠勾/紅框殘留）
	  function clearClientValidation() {
	    formNode.classList.remove('was-validated');
	    formNode.querySelectorAll('.is-invalid,.is-valid').forEach(el => {
	      el.classList.remove('is-invalid','is-valid');
	    });
	  }
	
	  // 點「編輯」→ 以 DB 原值開窗
	  editBtn.addEventListener('click', () => {
	    fillWithDbDefaults();
	    clearClientValidation();
	    modal.show();
	  });
	
	  // 關窗時清理驗證樣式（下次打開乾淨）
	  modalNode.addEventListener('hidden.bs.modal', clearClientValidation);
	
	  /* // 前端 HTML5 驗證（與 Bootstrap 樣式）
	  formNode.addEventListener('submit', function (e) {
	    if (!this.checkValidity()) {
	      e.preventDefault();
	      e.stopPropagation();
	    }
	    this.classList.add('was-validated');
	  }); */
	})();
	</script>
	

    <!-- <script>
      // 開啟編輯
      const modal = new bootstrap.Modal(document.getElementById('editModal'));
      document.getElementById('btnEdit').addEventListener('click', ()=> editModal.show());
      

      // 儲存
      document.getElementById('btnSave').addEventListener('click', ()=>{
        const name = document.getElementById('fName').value.trim();
        const phone = document.getElementById('fPhone').value.trim();
        const email = document.getElementById('fEmail').value.trim();
        const intro = document.getElementById('fIntro').value.trim();
        if(!name){ alert('請填寫名稱'); return; }
        document.getElementById('vName').textContent = name || '-';
        document.getElementById('vPhone').textContent = phone || '-';
        document.getElementById('vEmail').textContent = email || '-';
        document.getElementById('vIntro').textContent = intro || '（尚未填寫介紹）';
        editModal.hide();
      });
    </script> -->


	<script>
	(function setupSidebarActive(){
		  const menu = document.querySelector('.sidebar-menu');
		  if (!menu) return;

		  // 清掉舊狀態
		  menu.querySelectorAll('a.nav-link.active').forEach(a => a.classList.remove('active'));
		  menu.querySelectorAll('li.nav-item.menu-open').forEach(li => li.classList.remove('menu-open'));

		  // 找目前頁
		  const here = new URL(location.href).pathname;
		  const links = [...menu.querySelectorAll('a.nav-link[href]:not([href="#"])')];

		  let activeLink = links.find(a => {
		    try { return new URL(a.getAttribute('href'), location.origin).pathname === here; }
		    catch { return false; }
		  });
		  if (!activeLink) {
		    const hereName = here.split('/').pop();
		    activeLink = links.find(a => (a.getAttribute('href')||'').split('/').pop() === hereName);
		  }
		  if (!activeLink) return;

		  // 高亮 + 展開父群組（交給 AdminLTE 處理動畫與互斥）
		  activeLink.classList.add('active');
		  activeLink.closest('.nav-treeview')?.closest('.nav-item')?.classList.add('menu-open');
		})();

	</script>
    <script>
    (async () => {
      // 讓放了 data-include 的容器先隱藏，避免 FOUC
      document.querySelectorAll('[data-include]').forEach(el => el.style.visibility = 'hidden');

      // 載入所有 partial
      const tasks = [...document.querySelectorAll('[data-include]')].map(async (el) => {
        const url = el.getAttribute('data-include');
        const bust = `v=${encodeURIComponent((window.__PARTIALS_VERSION__) || '1')}`; // 可手動改版本清快取
        const src = url.includes('?') ? `${url}&${bust}` : `${url}?${bust}`;
        try {
          const res = await csrfFetchToRedirect(src, { cache: 'no-store' });
          if (!res.ok) throw new Error(res.statusText);
          el.innerHTML = await res.text();
          el.style.visibility = 'visible';
          el.dispatchEvent(new CustomEvent('partial:loaded', { bubbles: true }));
        } catch (err) {
          el.innerHTML = `<!-- include failed: ${url} -->`;
          el.style.visibility = 'visible';
          console.warn('Include failed:', url, err);
        }
      });

      await Promise.all(tasks);

     /*  // 1) 根據目前 URL 自動加上 active（如果 sidebar 裡的 a[href] 剛好指到當前頁）
   		// 呼叫時機：partials 載入完 & DOM 準備好
      document.addEventListener('partial:loaded', setupSidebar);
      document.addEventListener('DOMContentLoaded', setupSidebar);

      function setupSidebar(){
        const herePath = new URL(location.href).pathname; // 例如 /back-end/exhibitor/exhibitor_info
        const aside = document.querySelector('aside');
        if(!aside) return;

        // 1-1) 清理舊狀態
        aside.querySelectorAll('a.nav-link.active').forEach(a=>a.classList.remove('active'));
        aside.querySelectorAll('.nav-item.menu-open').forEach(li=>li.classList.remove('menu-open'));

        // 1-2) 找出與目前路徑完全相同的連結
        const links = [...aside.querySelectorAll('a.nav-link[href]')];
        const activeLink =
          links.find(a => {
            try {
              return new URL(a.getAttribute('href'), location.origin).pathname === herePath;
            } catch { return false; }
          }) ||
          // 退一步：以檔名比對
          links.find(a => (a.getAttribute('href')||'').split('/').pop() === herePath.split('/').pop());

        if(!activeLink) return;

        // 1-3) 標記 active 並僅打開該群組
        activeLink.classList.add('active');
        const group = activeLink.closest('.nav-item'); // 上層群組 li
        if(group){
          group.classList.add('menu-open'); // AdminLTE 會顯示這組的 .nav-treeview
        }

        // 1-4) 其餘群組保持關閉（無 menu-open 就是關閉）
        aside.querySelectorAll('.nav.nav-treeview').forEach(ul => {
          const parent = ul.closest('.nav-item');
          ul.style.display = parent?.classList.contains('menu-open') ? '' : 'none';
        });
      }

      // 2) AdminLTE 如果要初始化（依你專案需要）
      // window.AdminLTE && window.AdminLTE.autoInit?.(); */

      // 3) 登出（若要清 sessionStorage / localStorage）
      const logout = document.getElementById('mylogout');
      if (logout) {
        logout.addEventListener('click', (e) => {
          e.preventDefault(); // 若要攔截導頁再手動跳轉，取消註解
//           sessionStorage.removeItem('auth');       // 依專案實際使用的 key
//           sessionStorage.removeItem('editingEvent');
          // location.href = logout.getAttribute('href'); // 若攔截，最後導回登入頁
          
          // 可以不用 csrfFetch (有另外放權限)
          fetch("/api/auth/logout/exhibitor", { 
        	method: "POST",
          })
          .then((res) => {
        	  if(res.status === 204)
        		  location.href = "/back-end/exhibitor/exhibitor_login";
        	  if(!res.ok) throw new Error("Not 2XX");
          })
          .catch(error => console.log(error))
          
        });
      }
    })();
    </script>
    <script>
	document.addEventListener('DOMContentLoaded', () => {
	  // 單一成功訊息：2.5 秒後自動關閉
	  const ok = document.querySelector('.alert.alert-success');
	  if (ok) setTimeout(() => bootstrap.Alert.getOrCreateInstance(ok).close(), 2500);
	});
	</script>
	<script th:inline="javascript">
	(function () {
	  // 從後端塞到 model 的安全布林；若沒塞就回退 false
	  const HAS_ERRORS = /*[[${hasErrors}]]*/ false;
	
	  function showEditModalIfNeeded() {
	    try {
	      const modalEl = document.getElementById('editModal');
	      const editBtn = document.getElementById('btnEdit');
	      if (!modalEl) return;
	
	      // 點「編輯」→ 開窗
	      if (editBtn) {
	        editBtn.addEventListener('click', () => {
	          if (!window.bootstrap?.Modal) return;
	          const m = bootstrap.Modal.getOrCreateInstance(modalEl);
	          m.show();
	        });
	      }
	
	      // 後端驗證失敗 → 自動開窗顯示 th:errors
	      if (HAS_ERRORS && window.bootstrap?.Modal) {
	        const m = bootstrap.Modal.getOrCreateInstance(modalEl);
	        m.show();
	      }
	    } catch (err) {
	      console.warn('edit modal init failed:', err);
	    }
	  }
	
	  // 若你有用 async 載入 header 的 window.__partialsReady，就等它；否則直接做
	  const ready = (window.__partialsReady && typeof window.__partialsReady.then === 'function')
	    ? window.__partialsReady : Promise.resolve();
	
	  ready.then(() => {
	    if (document.readyState === 'loading') {
	      document.addEventListener('DOMContentLoaded', showEditModalIfNeeded);
	    } else {
	      showEditModalIfNeeded();
	    }
	  });
	})();
	</script>
	
    
  </body>
</html>

<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<title>Exhibitor | 展覽列表</title>

<link rel="preload" href="/back-end/css/adminlte.css" as="style" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
	crossorigin="anonymous" media="print" onload="this.media='all'" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="/back-end/css/adminlte.css" />
<style>
.filter-chips .btn {
	--bs-btn-padding-y: .25rem;
	--bs-btn-padding-x: .5rem;
	--bs-btn-font-size: .8rem
}

.tableFixHead {
	max-height: 520px;
	overflow: auto
}

.tableFixHead thead th {
	position: sticky;
	top: 0;
	z-index: 5
}

.status-pill {
	padding: .125rem .5rem;
	border-radius: 999px;
	font-size: .75rem;
}

.status-草稿 {
	background: #f1f3f5
}

.status-售票中 {
	background: #d1e7dd
}

.status-尚未開賣 {
	background: #e7f1ff
}

.status-已結束 {
	background: #fde2e1
}

.audit-已通過 {
	background: #e6f4ea
}

.audit-待審核 {
	background: #fff4d6
}

.audit-未通過 {
	background: #ffe2e2
}
</style>
</head>
<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
	<div class="app-wrapper">
		<!-- Header（自動注入） -->
		<div data-include="/back-end/header.html"></div>


		<!-- Sidebar -->
		<aside class="app-sidebar bg-body-secondary" data-bs-theme="dark">
			<div class="sidebar-brand">
				<a href="/back-end/exhibitor/back_end_homepage" class="brand-link"> <img
					src="/back-end/img/AdminLTELogo.png" alt="AdminLTE Logo"
					class="brand-image opacity-75 shadow" /> <span
					class="brand-text fw-light">eventra</span>
				</a>
			</div>
			<div class="sidebar-wrapper">
				<nav class="mt-2">
					<ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview"
						role="navigation" data-accordion="true">
						<li class="nav-item"><a href="#" class="nav-link"><i
								class="nav-icon bi bi-circle-fill"></i>
								<p>展覽管理</p></a>
							<ul class="nav nav-treeview">
								<li class="nav-item"><a
									href="/back-end/exhibitor/exhibition_list" class="nav-link"><p>展覽列表</p></a></li>
							</ul></li>
						<li class="nav-item"><a href="#" class="nav-link"><i
								class="nav-icon bi bi-circle-fill"></i>
								<p>銷售管理</p></a>
							<ul class="nav nav-treeview">
								<li class="nav-item"><a
									href="/back-end/exhibitor/order_list" class="nav-link"><p>訂單列表</p></a></li>
								<!-- <li class="nav-item"><a href="#" class="nav-link"><p>銷售列表</p></a></li> -->
							</ul></li>
						<li class="nav-item"><a href="#" class="nav-link"><i
								class="nav-icon bi bi-circle-fill"></i>
								<p>會員中心</p></a>
							<ul class="nav nav-treeview">
								<li class="nav-item"><a
									href="/back-end/exhibitor/exhibitor_info" class="nav-link"><p>展商資訊</p></a></li>
								<li class="nav-item"><a
									href="/back-end/exhibitor/exhibitor_account_data"
									class="nav-link"><p>帳戶資料</p></a></li>
							</ul></li>
					</ul>
				</nav>
				<!-- 底部：登出連結 -->
				<div class="p-3 border-top">
					<a href="/back-end/exhibitor/exhibitor_login" id="mylogout"
						class="nav-link text-danger"> <i
						class="bi bi-box-arrow-right me-1"></i> 登出
					</a>
				</div>
			</div>
		</aside>

		<!-- Main -->
		<main class="app-main">
			<div class="app-content-header">
				<div class="container-fluid">
					<div class="row align-items-center">
						<div class="col-sm-6">
							<h3 class="mb-0">展覽列表</h3>
						</div>
						<div class="col-sm-6 text-sm-end mt-2 mt-sm-0"></div>
					</div>
				</div>
			</div>

			<div class="app-content">
				<div class="container-fluid">
				<div class="card">
  					<div class="card-header d-flex flex-wrap gap-2 align-items-center">
					<div class="filter-chips btn-group" role="group" aria-label="tabs">
						  <a class="btn btn-outline-secondary btn-sm"
						     th:classappend="${tab}=='all' ? ' active'"
						     th:href="@{/back-end/exhibitor/exhibition_list(tab='all', page=0, size=${param.size} ?: 10, q=${q})}">
						    All
						  </a>
						 <!--  <a class="btn btn-outline-secondary btn-sm"
						     th:classappend="${tab}=='pending' ? ' active'"
						     th:href="@{/back-end/exhibitor/exhibition_list(tab='pending', page=0, size=${param.size} ?: 10, q=${q})}">
						    待審核
						  </a> -->
						<!--   <a class="btn btn-outline-secondary btn-sm"
						     th:classappend="${tab}=='rejected' ? ' active'"
						     th:href="@{/back-end/exhibitor/exhibition_list(tab='rejected', page=0, size=${param.size} ?: 10, q=${q})}">
						    未通過審核
						  </a> -->
						  <a class="btn btn-outline-secondary btn-sm"
						     th:classappend="${tab}=='not_on_sale' ? ' active'"
						     th:href="@{/back-end/exhibitor/exhibition_list(tab='not_on_sale', page=0, size=${param.size} ?: 10, q=${q})}">
						    尚未開賣
						  </a>
						  <a class="btn btn-outline-secondary btn-sm"
						     th:classappend="${tab}=='on_sale' ? ' active'"
						     th:href="@{/back-end/exhibitor/exhibition_list(tab='on_sale', page=0, size=${param.size} ?: 10, q=${q})}">
						    售票中
						  </a>
						  <a class="btn btn-outline-secondary btn-sm"
						     th:classappend="${tab}=='ended' ? ' active'"
						     th:href="@{/back-end/exhibitor/exhibition_list(tab='ended', page=0, size=${param.size} ?: 10, q=${q})}">
						    已結束
						  </a>
						   <a class="btn btn-outline-secondary btn-sm"
						     th:classappend="${tab}=='draft' ? ' active'"
						     th:href="@{/back-end/exhibitor/exhibition_list(tab='draft', page=0, size=${param.size} ?: 10, q=${q})}">
						    草稿
						  </a>
					</div>
						<!-- <div class="vr mx-1"></div> 
						<div class="dropdown"> <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">審核狀態</button> 
						<ul class="dropdown-menu" id="auditMenu"> <li><a class="dropdown-item" data-audit="">全部</a></li> <li><a class="dropdown-item" data-audit="待審核">待審核</a></li> 
						<li><a class="dropdown-item" data-audit="已通過">已通過</a></li> 
						<li><a class="dropdown-item" data-audit="未通過">未通過</a></li> 
						</ul>
						 </div> -->
						 <form th:action="@{/back-end/exhibitor/exhibition_list}" method="get" class="ms-auto d-flex gap-2">
						   <!-- 保留目前的分頁/分頁大小/目前的tab -->
						   <input type="hidden" name="tab" th:value="${tab}">
						   <input type="hidden" name="page" value="0"><!-- 搜尋時回到第一頁 -->
						   <input type="hidden" name="size" th:value="${param.size} ?: 10">
						
						   <div class="input-group input-group-sm" style="width: 240px;">
						     <span class="input-group-text"><i class="bi bi-search"></i></span>
						     <input type="text" class="form-control" name="q" th:value="${q}" placeholder="搜尋展覽名稱…">
						   </div>
						 </form>
						</div>

						<div class="card-body p-0 tableFixHead">
							<table
								class="table table-hover table-striped m-0 align-middle text-nowrap"
								id="eventsTable">
								<thead class="table-light">
									<tr>
										<th style="min-width: 220px">展覽名稱</th>
										<th style="min-width: 220px">展覽期間</th>
										<th style="min-width: 120px">展覽狀態</th>
										<th style="min-width: 160px">剩餘票數/總票數</th>
										<!-- <th style="min-width:120px">審核狀態</th> -->
										<th class="text-end" style="min-width: 160px">操作</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="ex : ${exhibitions}">
										<td th:text="${ex.exhibitionName}">展覽名稱</td>
										<td><span
											th:text="${#temporals.format(ex.startTime, 'yyyy/MM/dd HH:mm')}"></span>
											~ <span
											th:text="${#temporals.format(ex.endTime, 'yyyy/MM/dd HH:mm')}"></span>
										</td>
										<td><span class="status-pill"
											th:text="${ex.saleStatus}">尚未開賣</span></td>
										<td th:text="|${ex.leftTicketQuantity}/${ex.totalTicketQuantity?:0}|">0/0</td>
										<td class="text-end">
											<!-- 編輯模式 --> 
											<a th:href="@{/back-end/exhibitor/edit/{id}(id=${ex.exhibitionId})}"
											class="btn btn-outline-secondary btn-sm me-1"> <i
											class="bi bi-gear"></i> 編輯
											</a>
											<!-- 預覽 --> 
											<!-- <a
											th:href="@{/back-end/preview/{id}(id=${ex.exhibitionId})}"
											class="btn btn-outline-primary btn-sm"> <i
											class="bi bi-eye"></i> 預覽
											</a> -->
										</td>
									</tr>
								</tbody>
							</table>
						</div>

						<div
							class="card-footer d-flex flex-column align-items-center">

							<!-- 左邊顯示分頁資訊 -->
							<small class="text-secondary"> 第 <span
								th:text="${currentPage + 1}"></span> 頁，共 <span
								th:text="${totalPages}"></span> 頁， 總共 <span
								th:text="${totalElements}"></span> 筆資料
							</small>

							<!-- 右邊顯示分頁按鈕 -->
							<nav>
								<ul class="pagination pagination-sm mb-0 justify-content-center">
									<!-- 上一頁 -->
									<li class="page-item"
										th:classappend="${currentPage == 0} ? 'disabled'"><a
										class="page-link"
										th:href="@{/back-end/exhibitor/exhibition_list(tab=${tab}, q=${q},page=${currentPage - 1}, size=${10})}">«</a>
									</li>

									<!-- 頁碼 -->
									<li class="page-item"
										th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
										th:classappend="${i == currentPage} ? 'active'"><a
										class="page-link"
										th:href="@{/back-end/exhibitor/exhibition_list(tab=${tab}, q=${q},page=${i}, size=${10})}"
										th:text="${i + 1}"></a></li>

									<!-- 下一頁 -->
									<li class="page-item"
										th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
										<a class="page-link"
										th:href="@{/back-end/exhibitor/exhibition_list(tab=${tab}, q=${q},page=${currentPage + 1}, size=${10})}">»</a>
									</li>
								</ul>
							</nav>
						</div>
					</div>
				</div>
			</div>
		</main>

		<footer class="app-footer"></footer>
	</div>

	<!-- JS：用 bundle（已含 Popper） -->

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/browser/overlayscrollbars.browser.es6.min.js"></script>
	<script src="/back-end/js/adminlte.min.js"></script>
	<script src="/back-end/js/sidebar_toggle.js"></script>
	<script src="/front-end/js/g1_10_custom_common_csrf.js"></script>

	<script>
	(function setupSidebarActive(){
		  const menu = document.querySelector('.sidebar-menu');
		  if (!menu) return;

		  // 清掉舊狀態
		  menu.querySelectorAll('a.nav-link.active').forEach(a => a.classList.remove('active'));
		  menu.querySelectorAll('li.nav-item.menu-open').forEach(li => li.classList.remove('menu-open'));

		  // 找目前頁
		  const here = new URL(location.href).pathname;
		  const links = [...menu.querySelectorAll('a.nav-link[href]:not([href="#"])')];

		  let activeLink = links.find(a => {
		    try { return new URL(a.getAttribute('href'), location.origin).pathname === here; }
		    catch { return false; }
		  });
		  if (!activeLink) {
		    const hereName = here.split('/').pop();
		    activeLink = links.find(a => (a.getAttribute('href')||'').split('/').pop() === hereName);
		  }
		  if (!activeLink) return;

		  // 高亮 + 展開父群組（交給 AdminLTE 處理動畫與互斥）
		  activeLink.classList.add('active');
		  activeLink.closest('.nav-treeview')?.closest('.nav-item')?.classList.add('menu-open');
		})();

	</script>

	<script>
	(async () => {
		  // 先把 partials 載入
		  const tasks = [...document.querySelectorAll('[data-include]')].map(async (el) => {
		    const url = el.getAttribute('data-include');
		    const bust = `v=${encodeURIComponent((window.__PARTIALS_VERSION__) || '1')}`;
		    const src = url.includes('?') ? `${url}&${bust}` : `${url}?${bust}`;
		    try {
		      const res = await csrfFetchToRedirect(src, { cache: 'no-store' });
		      el.innerHTML = await res.text();
		    } catch (_) {}
		  });
		  await Promise.all(tasks);

		  /* // >>> 重要：載入完就「直接呼叫一次」
		  setupSidebar();

		  // 之後若有 partial 再次載入，也能觸發
		  document.addEventListener('partial:loaded', setupSidebar);
		  // 有些瀏覽器使用 bfcache 返回頁面時用 pageshow，補一個保險
		  window.addEventListener('pageshow', setupSidebar);

		  function setupSidebar(){
		    const herePath = location.pathname; // 例：/back-end/exhibitor/exhibitor_info
		    const aside = document.querySelector('aside');
		    if(!aside) return;

		    // 清理
		    aside.querySelectorAll('a.nav-link.active').forEach(a=>a.classList.remove('active'));
		    aside.querySelectorAll('.nav-item.menu-open').forEach(li=>li.classList.remove('menu-open'));

		    // 尋找當前連結
		    const links = [...aside.querySelectorAll('a.nav-link[href]')];
		    const activeLink =
		      links.find(a => {
		        try { return new URL(a.getAttribute('href'), location.origin).pathname === herePath; }
		        catch { return false; }
		      }) ||
		      links.find(a => (a.getAttribute('href')||'').split('/').pop() === herePath.split('/').pop());

		    if(!activeLink) return;

		    // 標記 active + 展開唯一群組
		    activeLink.classList.add('active');
		    activeLink.closest('.nav-item')?.classList.add('menu-open');  */

		    // **不要**再手動改 .nav-treeview 的 display，讓 AdminLTE 自己控管
		  /* } */

		  // AdminLTE 自動初始化（可留）
		/*   window.AdminLTE && window.AdminLTE.autoInit?.(); */
		

      // 3) 登出（若要清 sessionStorage / localStorage）
      const logout = document.getElementById('mylogout');
      if (logout) {
        logout.addEventListener('click', (e) => {
          e.preventDefault(); // 若要攔截導頁再手動跳轉，取消註解
//           sessionStorage.removeItem('auth');       // 依專案實際使用的 key
//           sessionStorage.removeItem('editingEvent');
          // location.href = logout.getAttribute('href'); // 若攔截，最後導回登入頁
          
          // 可以不用 csrfFetch (有另外放權限)
          fetch("/api/auth/logout/exhibitor", { 
        	method: "POST",
          })
          .then((res) => {
        	  if(res.status === 204)
        		  location.href = "/back-end/exhibitor/exhibitor_login";
        	  if(!res.ok) throw new Error("Not 2XX");
          })
          .catch(error => console.log(error))
          
        });
      }
     })(); 
    </script>
</body>
</html>

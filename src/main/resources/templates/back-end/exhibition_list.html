<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<title>Exhibitor | 展覽列表</title>

<link rel="preload" href="/back-end/css/adminlte.css" as="style" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
	crossorigin="anonymous" media="print" onload="this.media='all'" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="/back-end/css/adminlte.css" />
<style>
.filter-chips .btn {
	--bs-btn-padding-y: .25rem;
	--bs-btn-padding-x: .5rem;
	--bs-btn-font-size: .8rem
}

.tableFixHead {
	max-height: 520px;
	overflow: auto
}

.tableFixHead thead th {
	position: sticky;
	top: 0;
	z-index: 5
}

.status-pill {
	padding: .125rem .5rem;
	border-radius: 999px;
	font-size: .75rem;
}

.status-草稿 {
	background: #f1f3f5
}

.status-售票中 {
	background: #d1e7dd
}

.status-尚未開賣 {
	background: #e7f1ff
}

.status-已結束 {
	background: #fde2e1
}

.audit-已通過 {
	background: #e6f4ea
}

.audit-待審核 {
	background: #fff4d6
}

.audit-未通過 {
	background: #ffe2e2
}
</style>
</head>
<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
	<div class="app-wrapper">
		<!-- Header（自動注入） -->
		<div data-include="/back-end/header.html"></div>


		<!-- Sidebar -->
		<aside class="app-sidebar bg-body-secondary" data-bs-theme="dark">
			<div class="sidebar-brand">
				<a href="#" class="brand-link"> <img
					src="/back-end/img/AdminLTELogo.png" alt="AdminLTE Logo"
					class="brand-image opacity-75 shadow" /> <span
					class="brand-text fw-light">eventra</span>
				</a>
			</div>
			<div class="sidebar-wrapper">
				<nav class="mt-2">
					<ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview"
						role="navigation" data-accordion="false">
						<li class="nav-item"><a class="nav-link"><p>展商後台</p></a></li>
						<li class="nav-item menu-open"><a href="#" class="nav-link"><i
								class="nav-icon bi bi-circle-fill"></i>
							<p>展覽管理</p></a>
							<ul class="nav nav-treeview">
								<li class="nav-item"><a
									href="/back-end/exhibitor/exhibition_list" class="nav-link"><p>展覽列表</p></a></li>
							</ul></li>
						<li class="nav-item menu-open"><a href="#" class="nav-link"><i
								class="nav-icon bi bi-circle-fill"></i>
							<p>銷售管理</p></a>
							<ul class="nav nav-treeview">
								<li class="nav-item"><a
									href="/back-end/exhibitor/order_list" class="nav-link"><p>訂單列表</p></a></li>
								<li class="nav-item"><a href="#" class="nav-link"><p>銷售列表</p></a></li>
							</ul></li>
						<li class="nav-item menu-open"><a href="#" class="nav-link"><i
								class="nav-icon bi bi-circle-fill"></i>
							<p>會員中心</p></a>
							<ul class="nav nav-treeview">
								<li class="nav-item"><a
									href="/back-end/exhibitor/exhibitor_info" class="nav-link"><p>展商資訊</p></a></li>
								<li class="nav-item"><a
									href="/back-end/exhibitor/exhibitor_account_data"
									class="nav-link"><p>帳戶資料</p></a></li>
							</ul></li>
					</ul>
				</nav>
				<!-- 底部：登出連結 -->
				<div class="p-3 border-top">
					<a href="/back-end/exhibitor/exhibitor_login" id="mylogout"
						class="nav-link text-danger"> <i
						class="bi bi-box-arrow-right me-1"></i> 登出
					</a>
				</div>
			</div>
		</aside>

		<!-- Main -->
		<main class="app-main">
			<div class="app-content-header">
				<div class="container-fluid">
					<div class="row align-items-center">
						<div class="col-sm-6">
							<h3 class="mb-0">展覽列表</h3>
						</div>
						<div class="col-sm-6 text-sm-end mt-2 mt-sm-0"></div>
					</div>
				</div>
			</div>

			<div class="app-content">
				<div class="container-fluid">
					<div class="card">
						<div class="card-header d-flex flex-wrap gap-2 align-items-center">
							<div class="filter-chips btn-group" role="group"
								aria-label="tabs">
								<button type="button"
									class="btn btn-outline-secondary btn-sm active" data-tab="all">All</button>
								<button type="button" class="btn btn-outline-secondary btn-sm"
									data-tab="draft">草稿</button>
								<button type="button" class="btn btn-outline-secondary btn-sm"
									data-status="尚未開賣">尚未開賣</button>
								<button type="button" class="btn btn-outline-secondary btn-sm"
									data-status="售票中">售票中</button>
								<button type="button" class="btn btn-outline-secondary btn-sm"
									data-status="已結束">已結束</button>
							</div>
							<div class="vr mx-1"></div>
							<div class="dropdown">
								<button class="btn btn-outline-secondary btn-sm dropdown-toggle"
									data-bs-toggle="dropdown">審核狀態</button>
								<ul class="dropdown-menu" id="auditMenu">
									<li><a class="dropdown-item" data-audit="">全部</a></li>
									<li><a class="dropdown-item" data-audit="待審核">待審核</a></li>
									<li><a class="dropdown-item" data-audit="已通過">已通過</a></li>
									<li><a class="dropdown-item" data-audit="未通過">未通過</a></li>
								</ul>
							</div>
							<div class="ms-auto d-flex gap-2">
								<div class="input-group input-group-sm" style="width: 240px;">
									<span class="input-group-text"><i class="bi bi-search"></i></span>
									<input type="text" class="form-control" id="q"
										placeholder="搜尋展覽名稱…">
								</div>
							</div>
						</div>

						<div class="card-body p-0 tableFixHead">
							<table
								class="table table-hover table-striped m-0 align-middle text-nowrap"
								id="eventsTable">
								<thead class="table-light">
									<tr>
										<th style="min-width: 220px">展覽名稱</th>
										<th style="min-width: 220px">展覽期間</th>
										<th style="min-width: 120px">展覽狀態</th>
										<th style="min-width: 160px">剩餘票數/總票數</th>
										<!-- <th style="min-width:120px">審核狀態</th> -->
										<th class="text-end" style="min-width: 160px">操作</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="ex : ${exhibitions}">
										<td th:text="${ex.exhibitionName}">展覽名稱</td>
										<td><span
											th:text="${#temporals.format(ex.startTime, 'yyyy/MM/dd HH:mm')}"></span>
											~ <span
											th:text="${#temporals.format(ex.endTime, 'yyyy/MM/dd HH:mm')}"></span>
										</td>
										<td><span class="status-pill"
											th:text="${ex.exhibitionStatus.exhibitionStatus}">1</span></td>
										<td th:text="${ex.totalTicketQuantity}">0</td>
										<!-- <td>
                   	  <span class="status-pill" th:text="${ex.reviewStatusId}"></span>
                   </td> -->
									</tr>
								</tbody>
							</table>
						</div>

						<div
							class="card-footer d-flex justify-content-between align-items-center">

							<!-- 左邊顯示分頁資訊 -->
							<small class="text-secondary"> 第 <span
								th:text="${currentPage + 1}"></span> 頁，共 <span
								th:text="${totalPages}"></span> 頁， 總共 <span
								th:text="${totalElements}"></span> 筆資料
							</small>

							<!-- 右邊顯示分頁按鈕 -->
							<nav>
								<ul class="pagination pagination-sm mb-0">
									<!-- 上一頁 -->
									<li class="page-item"
										th:classappend="${currentPage == 0} ? 'disabled'"><a
										class="page-link"
										th:href="@{/back-end/exhibitor/exhibition_list(page=${currentPage - 1}, size=${10})}">«</a>
									</li>

									<!-- 頁碼 -->
									<li class="page-item"
										th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
										th:classappend="${i == currentPage} ? 'active'"><a
										class="page-link"
										th:href="@{/back-end/exhibitor/exhibition_list(page=${i}, size=${10})}"
										th:text="${i + 1}"></a></li>

									<!-- 下一頁 -->
									<li class="page-item"
										th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
										<a class="page-link"
										th:href="@{/back-end/exhibitor/exhibition_list(page=${currentPage + 1}, size=${10})}">»</a>
									</li>
								</ul>
							</nav>
						</div>
					</div>
				</div>
			</div>
		</main>

		<footer class="app-footer"></footer>
	</div>

	<!-- JS：用 bundle（已含 Popper） -->

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/browser/overlayscrollbars.browser.es6.min.js"></script>
	<script src="/back-end/js/adminlte.min.js"></script>
	<script src="/front-end/js/g1_10_custom_common_csrf.js"></script>

	<script>
  // ===================== 1) 讀資料（demo + localStorage 合併） =====================
  const demoEvents = [
    {id:1,name:'活動1', startAt:'2025-07-18T10:00', endAt:'2025-07-20T18:00', saleOpenAt:'2025-07-01', status:'售票中',  remain:98, total:100, audit:'已通過'},
    {id:2,name:'活動2', startAt:'2025-07-25T09:00', endAt:'2025-07-25T17:00', saleOpenAt:'',           status:'籌備中',  remain:null, total:null, audit:'已通過'},
    {id:3,name:'活動3', startAt:'2025-07-01T09:00', endAt:'2025-07-05T17:00', saleOpenAt:'2025-06-01', status:'已結束',  remain:0,   total:200, audit:'已通過'},
    {id:4,name:'活動4', startAt:'',                 endAt:'',                 saleOpenAt:'',           status:'草稿',    remain:null, total:null, audit:''},
    {id:5,name:'活動5', startAt:'2025-08-10T10:00', endAt:'2025-08-12T18:00', saleOpenAt:'2025-08-05', status:'尚未開賣', remain:null, total:null, audit:'待審核'},
    {id:6,name:'活動6', startAt:'2024-06-04T10:00', endAt:'2024-06-06T18:00', saleOpenAt:'2024-05-20', status:'草稿',    remain:null, total:null, audit:'未通過'},
  ]; 
  
/* 
  const stored = JSON.parse(localStorage.getItem('events') || '[]');
  const byId = new Map();
  demoEvents.forEach(ev => byId.set(ev.id, {...ev}));
  stored.forEach(ev => byId.set(ev.id, {...ev}));
  let events = Array.from(byId.values()); */

  // ===================== 2) 狀態 / DOM =====================
  let page = 1, pageSize = 8;
  let filter = { tab: 'all', status: '', audit: '', q: '' };

  const tbody     = document.getElementById('eventTbody');
  const pager     = document.getElementById('pager');
  const countInfo = document.getElementById('countInfo');

  // ===================== 3) 小工具 =====================
  function pad(n){ return String(n).padStart(2,'0'); }
  function fmtDateTime(iso){
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d)) return '';
    return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function fmtRange(startISO, endISO){
    const s = fmtDateTime(startISO);
    const e = fmtDateTime(endISO);
    if (!s && !e) return '';
    if (s && !e)  return s;
    if (!s && e)  return e;
    const [sd, st] = s.split(' ');
    const [ed, et] = e.split(' ');
    return sd === ed ? `${sd} ${st}–${et}` : `${s} ~ ${e}`;
  }
  function fmtQty(remain, total){
    return (remain==null || total==null) ? '-' : `${remain}/${total}`;
  }

  // 以「開賣日 → 結束時間」判斷
  function computeStatusBySaleOpen(saleOpenISO, endISO){
    if (!saleOpenISO || !endISO) return '尚未開賣';
    const s = new Date(saleOpenISO.length === 10 ? (saleOpenISO + 'T00:00') : saleOpenISO);
    const e = new Date(endISO);
    const now = new Date();
    if (now < s) return '尚未開賣';
    if (now > e) return '已結束';
    return '售票中';
  }

  // ===================== 4) 渲染 =====================
  function render(){
    // 先以 saleOpenAt/endAt 更新非草稿活動的狀態
    events = events.map(ev => {
      if (ev.status !== '草稿' && (ev.saleOpenAt || ev.endAt)) {
        return { ...ev, status: computeStatusBySaleOpen(ev.saleOpenAt || '', ev.endAt || '') };
      }
      return ev;
    });

    // 篩選
    let rows = events.filter(ev => {
      if (filter.tab === 'draft' && ev.status !== '草稿') return false;
      if (filter.status && ev.status !== filter.status)  return false;
      if (filter.audit  && ev.audit  !== filter.audit)   return false;
      if (filter.q      && !ev.name.toLowerCase().includes(filter.q.toLowerCase())) return false;
      return true;
    });

    // 分頁
    const total = rows.length;
    const pages = Math.max(1, Math.ceil(total / pageSize));
    page = Math.min(page, pages);
    const startIdx = (page - 1) * pageSize;
    rows = rows.slice(startIdx, startIdx + pageSize);

    // 寫表格
    tbody.innerHTML = '';
    rows.forEach(ev => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ev.name}</td>
        <td>${fmtRange(ev.startAt, ev.endAt)}</td>
        <td><span class="status-pill status-${ev.status}">${ev.status || ''}</span></td>
        <td>${fmtQty(ev.remain, ev.total)}</td>
        <td><span class="status-pill audit-${ev.audit}">${ev.audit || ''}</span></td>
        <td class="text-end">
          <button class="btn btn-outline-secondary btn-sm me-1" data-op="edit" data-id="${ev.id}">
            <i class="bi bi-gear"></i> 管理
          </button>
          <button class="btn btn-outline-primary btn-sm" data-op="preview" data-id="${ev.id}">
            <i class="bi bi-eye"></i> 預覽
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // 頁碼
    pager.innerHTML = '';
    for (let i = 1; i <= pages; i++){
      const li = document.createElement('li');
      li.className = 'page-item' + (i === page ? ' active' : '');
      li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
      li.addEventListener('click', e => { e.preventDefault(); page = i; render(); });
      pager.appendChild(li);
    }
    countInfo.textContent = `共 ${total} 筆，顯示第 ${total ? startIdx + 1 : 0}-${Math.min(startIdx + rows.length, total)} 筆`;
  }

    // ===================== 5) 綁定 =====================
  // 分類（All / 草稿 / 狀態 chips）
  document.querySelectorAll('.filter-chips [data-tab], .filter-chips [data-status]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-chips .btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      filter.tab    = btn.dataset.tab    || 'all';
      filter.status = btn.dataset.status || '';
      page = 1;
      render();
    });
  });

  // 審核狀態下拉
  document.getElementById('auditMenu')?.addEventListener('click', e => {
    const a = e.target.closest('a[data-audit]');
    if (!a) return;
    filter.audit = a.dataset.audit || '';
    page = 1;
    render();
  });

  // 搜尋
  const $q = document.getElementById('q');
  $q?.addEventListener('keydown', e => {
    if (e.key === 'Enter'){
      filter.q = e.target.value.trim();
      page = 1;
      render();
    }
  });
  $q?.addEventListener('input', e => {
    if (e.target.value === ''){
      filter.q = '';
      render();
    }
  });

  // 表格內操作（管理 / 預覽）
  tbody.addEventListener('click', e => {
    const btn = e.target.closest('button[data-op]');
    if (!btn) return;
    const id = +btn.dataset.id;
    const ev = events.find(x => x.id === id);
    if (!ev) return;

    if (btn.dataset.op === 'edit'){
      // 丟到 sessionStorage，帶 edit 參數，去建立頁
      sessionStorage.setItem('editingEvent', JSON.stringify(ev));
      location.href = `./create_event.html?edit=${ev.id}`;
    } else if (btn.dataset.op === 'preview'){
      alert(`預覽展覽：${ev.name}`);
    }
  });

  // ===================== 6) 首次渲染 =====================
  render();
  document.addEventListener('click', (e) => {
  const a = e.target.closest('a[href="./create_event.html"]');
  if (a) sessionStorage.removeItem('editingEvent');
});
  </script>
	<script>
	document.getElementById("myLogout")?.addEventListener("click", (e) => {
		  e.preventDefault();
		  sessionStorage.clear();
		  window.location.href = "/back-end/exhibitor/exhibitor_login";
		});
      </script>

	<script>
    (async () => {
      // 讓放了 data-include 的容器先隱藏，避免 FOUC
      document.querySelectorAll('[data-include]').forEach(el => el.style.visibility = 'hidden');

      // 載入所有 partial
      const tasks = [...document.querySelectorAll('[data-include]')].map(async (el) => {
        const url = el.getAttribute('data-include');
        const bust = `v=${encodeURIComponent((window.__PARTIALS_VERSION__) || '1')}`; // 可手動改版本清快取
        const src = url.includes('?') ? `${url}&${bust}` : `${url}?${bust}`;
        try {
          const res = await csrfFetchToRedirect(src, { cache: 'no-store' });
          if (!res.ok) throw new Error(res.statusText);
          el.innerHTML = await res.text();
          el.style.visibility = 'visible';
          el.dispatchEvent(new CustomEvent('partial:loaded', { bubbles: true }));
        } catch (err) {
          el.innerHTML = `<!-- include failed: ${url} -->`;
          el.style.visibility = 'visible';
          console.warn('Include failed:', url, err);
        }
      });

      await Promise.all(tasks);

      // 1) 根據目前 URL 自動加上 active（如果 sidebar 裡的 a[href] 剛好指到當前頁）
      const here = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('aside a.nav-link, aside .nav-treeview a.nav-link').forEach(a => {
        const href = (a.getAttribute('href') || '').split('/').pop();
        if (href && href === here) a.classList.add('active');
      });

      // 2) AdminLTE 如果要初始化（依你專案需要）
      // window.AdminLTE && window.AdminLTE.autoInit?.();

      // 3) 登出（若要清 sessionStorage / localStorage）
      const logout = document.getElementById('logoutLink');
      if (logout) {
        logout.addEventListener('click', (e) => {
          // e.preventDefault(); // 若要攔截導頁再手動跳轉，取消註解
          sessionStorage.removeItem('auth');       // 依專案實際使用的 key
          sessionStorage.removeItem('editingEvent');
          // location.href = logout.getAttribute('href'); // 若攔截，最後導回登入頁
        });
      }
    })();
    </script>
</body>
</html>
